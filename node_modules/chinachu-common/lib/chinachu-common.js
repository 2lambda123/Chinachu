/*!
 *  Chinachu Common Module (node-chinachu-common)
 *
 *  Copyright (c) 2012 Yuki KAN and Chinachu Project Contributors
 *  http://chinachu.akkar.in/
**/

var fs     = require('fs');
var crypto = require('crypto');

exports.jsonWatcher = function(filepath, callback, option) {
	if (typeof option === 'undefined') option = {};
	
	option.wait = option.wait || 1000;
	
	if (!fs.existsSync(filepath)) {
		if (option.create) {
			fs.writeFileSync(filepath, JSON.stringify(option.create));
		} else {
			callback(null, 'FATAL: `' + filepath + '` is not exists.', null);
			return;
		}
	}
	
	function read() {
		try {
			var data = JSON.parse( fs.readFileSync(filepath, 'ascii') );
			callback(data, null, 'READ: `' + filepath + '` is updated.');
		} catch (e) {
			callback(null, 'WARN: `' + filepath + '` is invalid. (' + e + ')', null);
		}
	}
	
	if (option.now) read();
	
	var timer;
	function onUpdated() {
		clearTimeout(timer);
		timer = setTimeout(read, option.wait);
	}
	fs.watch(filepath, onUpdated);
};

exports.getProgramById = function(id, array) {
	return (function() {
		var x = null;
		
		array.forEach(function(a) {
			if (a.id === id) { x = a; }
		});
		
		return x;
	})();
};

exports.getRuleId = function(rule) {
	var obj = JSON.parse(JSON.stringify(rule));
	
	if (obj.isDisabled) {
		delete obj.isDisabled;
	}
	
	return crypto.createHash('md5').update(JSON.stringify(obj), 'utf8').digest('hex').slice(-8);
};